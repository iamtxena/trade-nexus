{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://trade-nexus.io/schemas/validation_run.json",
  "title": "Trade Nexus Validation Run Canonical Artifact",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schemaVersion",
    "runId",
    "createdAt",
    "requestId",
    "tenantId",
    "userId",
    "strategyRef",
    "inputs",
    "outputs",
    "deterministicChecks",
    "agentReview",
    "traderReview",
    "policy",
    "finalDecision"
  ],
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "validation-run.v1"
    },
    "runId": {
      "type": "string",
      "minLength": 1
    },
    "createdAt": {
      "type": "string",
      "format": "date-time"
    },
    "requestId": {
      "type": "string",
      "minLength": 1
    },
    "tenantId": {
      "type": "string",
      "minLength": 1
    },
    "userId": {
      "type": "string",
      "minLength": 1
    },
    "strategyRef": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "strategyId",
        "provider",
        "providerRefId"
      ],
      "properties": {
        "strategyId": {
          "type": "string",
          "minLength": 1
        },
        "provider": {
          "type": "string",
          "enum": [
            "lona"
          ]
        },
        "providerRefId": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "inputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "prompt",
        "requestedIndicators",
        "datasetIds",
        "backtestReportRef"
      ],
      "properties": {
        "prompt": {
          "type": "string",
          "minLength": 1
        },
        "requestedIndicators": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "datasetIds": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "backtestReportRef": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "strategyCodeRef",
        "backtestReportRef",
        "tradesRef",
        "executionLogsRef",
        "chartPayloadRef"
      ],
      "properties": {
        "strategyCodeRef": {
          "type": "string",
          "minLength": 1
        },
        "backtestReportRef": {
          "type": "string",
          "minLength": 1
        },
        "tradesRef": {
          "type": "string",
          "minLength": 1
        },
        "executionLogsRef": {
          "type": "string",
          "minLength": 1
        },
        "chartPayloadRef": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "deterministicChecks": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "indicatorFidelity",
        "tradeCoherence",
        "metricConsistency"
      ],
      "properties": {
        "indicatorFidelity": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "status",
            "missingIndicators"
          ],
          "properties": {
            "status": {
              "type": "string",
              "enum": [
                "pass",
                "fail"
              ]
            },
            "missingIndicators": {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        "tradeCoherence": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "status",
            "violations"
          ],
          "properties": {
            "status": {
              "type": "string",
              "enum": [
                "pass",
                "fail"
              ]
            },
            "violations": {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        "metricConsistency": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "status",
            "driftPct"
          ],
          "properties": {
            "status": {
              "type": "string",
              "enum": [
                "pass",
                "fail"
              ]
            },
            "driftPct": {
              "type": "number",
              "minimum": 0
            }
          }
        }
      }
    },
    "agentReview": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "status",
        "summary",
        "findings",
        "budget"
      ],
      "properties": {
        "status": {
          "type": "string",
          "enum": [
            "pass",
            "conditional_pass",
            "fail"
          ]
        },
        "summary": {
          "type": "string",
          "minLength": 1
        },
        "findings": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "id",
              "priority",
              "confidence",
              "summary",
              "evidenceRefs"
            ],
            "properties": {
              "id": {
                "type": "string",
                "minLength": 1
              },
              "priority": {
                "type": "integer",
                "minimum": 0,
                "maximum": 3
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1
              },
              "summary": {
                "type": "string",
                "minLength": 1
              },
              "evidenceRefs": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "string",
                  "minLength": 1
                }
              }
            }
          }
        },
        "budget": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "profile",
            "limits",
            "usage",
            "withinBudget",
            "breachReason"
          ],
          "properties": {
            "profile": {
              "type": "string",
              "enum": [
                "FAST",
                "STANDARD",
                "EXPERT"
              ]
            },
            "limits": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "maxRuntimeSeconds",
                "maxTokens",
                "maxToolCalls",
                "maxFindings"
              ],
              "properties": {
                "maxRuntimeSeconds": {
                  "type": "number",
                  "exclusiveMinimum": 0
                },
                "maxTokens": {
                  "type": "integer",
                  "minimum": 1
                },
                "maxToolCalls": {
                  "type": "integer",
                  "minimum": 0
                },
                "maxFindings": {
                  "type": "integer",
                  "minimum": 1
                }
              }
            },
            "usage": {
              "type": "object",
              "additionalProperties": false,
              "required": [
                "runtimeSeconds",
                "tokensUsed",
                "toolCallsUsed"
              ],
              "properties": {
                "runtimeSeconds": {
                  "type": "number",
                  "minimum": 0
                },
                "tokensUsed": {
                  "type": "integer",
                  "minimum": 0
                },
                "toolCallsUsed": {
                  "type": "integer",
                  "minimum": 0
                }
              }
            },
            "withinBudget": {
              "type": "boolean"
            },
            "breachReason": {
              "type": [
                "string",
                "null"
              ],
              "minLength": 1
            }
          }
        }
      }
    },
    "traderReview": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "required",
        "status",
        "comments"
      ],
      "properties": {
        "required": {
          "type": "boolean"
        },
        "status": {
          "type": "string",
          "enum": [
            "not_requested",
            "requested",
            "approved",
            "rejected"
          ]
        },
        "comments": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "policy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "profile",
        "blockMergeOnFail",
        "blockReleaseOnFail",
        "blockMergeOnAgentFail",
        "blockReleaseOnAgentFail",
        "requireTraderReview",
        "hardFailOnMissingIndicators",
        "failClosedOnEvidenceUnavailable"
      ],
      "properties": {
        "profile": {
          "type": "string",
          "enum": [
            "FAST",
            "STANDARD",
            "EXPERT"
          ]
        },
        "blockMergeOnFail": {
          "type": "boolean"
        },
        "blockReleaseOnFail": {
          "type": "boolean"
        },
        "blockMergeOnAgentFail": {
          "type": "boolean"
        },
        "blockReleaseOnAgentFail": {
          "type": "boolean"
        },
        "requireTraderReview": {
          "type": "boolean"
        },
        "hardFailOnMissingIndicators": {
          "type": "boolean",
          "const": true
        },
        "failClosedOnEvidenceUnavailable": {
          "type": "boolean",
          "const": true
        }
      }
    },
    "finalDecision": {
      "type": "string",
      "enum": [
        "pass",
        "conditional_pass",
        "fail"
      ]
    }
  }
}
