name: Backend Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

env:
  RESOURCE_GROUP: trade-nexus
  CONTAINER_APP: trade-nexus-backend
  ACR_NAME: tradenexusacr

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image
        working-directory: ./backend
        run: |
          IMAGE_TAG="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.CONTAINER_APP }}:${{ github.sha }}"
          IMAGE_LATEST="${{ secrets.ACR_LOGIN_SERVER }}/${{ env.CONTAINER_APP }}:latest"

          docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
          mkdir -p ../.ops/artifacts
          docker run --rm \
            -v "$PWD/..:/workspace" \
            -w /workspace/backend \
            $IMAGE_TAG \
            python -m src.platform_api.validation.release_gate_check \
              --output /workspace/.ops/artifacts/validation-replay-gate-backend-deploy.json

          docker push $IMAGE_TAG
          docker push $IMAGE_LATEST

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Summarize replay gate report (release deploy)
        if: always()
        run: |
          REPORT_PATH=".ops/artifacts/validation-replay-gate-backend-deploy.json"
          if [[ -f "${REPORT_PATH}" ]]; then
            python - <<'PY'
            import json
            import os
            from pathlib import Path

            report_path = Path(".ops/artifacts/validation-replay-gate-backend-deploy.json")
            payload = json.loads(report_path.read_text(encoding="utf-8"))
            gate = payload.get("gate", {})
            lines = [
                "### Validation Replay Gate Report (Release Deploy)",
                f"- gateStatus: `{payload.get('gateStatus')}`",
                f"- replayId: `{gate.get('id')}`",
                f"- baselineId: `{gate.get('baselineId')}`",
                f"- candidateRunId: `{gate.get('candidateRunId')}`",
            ]
            summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
            if summary_path:
                with Path(summary_path).open("a", encoding="utf-8") as summary_file:
                    summary_file.write("\n".join(lines) + "\n")
            print(json.dumps(payload, indent=2, sort_keys=True))
            PY
          else
            echo "Replay gate report missing at ${REPORT_PATH}" >&2
            exit 1
          fi

      - name: Upload replay gate report (release deploy)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-replay-gate-backend-deploy
          path: .ops/artifacts/validation-replay-gate-backend-deploy.json
          if-no-files-found: error

      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v2
        with:
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP }}
          imageToDeploy: ${{ env.IMAGE_TAG }}

      - name: Logout from Azure
        if: always()
        run: az logout
